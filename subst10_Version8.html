<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <title>教師代課系統 V15</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: auto; }
        .section { margin-bottom: 20px; }
        select, input, button { margin: 5px; padding: 5px; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <div class="container">
        <h1>教師代課系統 V15</h1>
        
        <div class="section">
            <h2>代課教師選擇優先級：</h2>
            <ul>
                <li>代堂數值最小的教師（負數最大）優先選擇</li>
                <li>當天較多空堂（即較少課堂）</li>
                <li>代堂後為空堂（可選）</li>
                <li>未達到當天堂數上限</li>
                <li>未被列入排除名單</li>
            </ul>
        </div>

        <div class="section">
            <h2>待更新的代課記錄:</h2>
            <input type="file" id="substFile" accept=".csv">
            <button onclick="downloadSubst()">下載代堂記錄更新版</button>
        </div>

        <div class="section">
            <h2>請假教師:</h2>
            <select id="absentTeacher">
                <option value="">-- 選擇教師 --</option>
            </select>
            <h3>請假類別:</h3>
            <select id="leaveType">
                <option value="病事假">病事假</option>
                <option value="講座">講座</option>
                <option value="職務">職務</option>
                <option value="侍產假">侍產假</option>
            </select>
        </div>

        <div class="section">
            <h2>顯示代課教師選擇優先級</h2>
            <label>代課日期:</label>
            <input type="date" id="subDate">
            <label><input type="checkbox" id="sixthFormFinished"> 中六課程已完結</label>
            <button onclick="arrangeSubstitution()">編排代課</button>
        </div>

        <div class="section">
            <h2>代課教師堂數上限:</h2>
            <select id="maxPeriods">
                <option value="3">3堂</option>
                <option value="4">4堂</option>
                <option value="5">5堂</option>
                <option value="6">6堂</option>
            </select>
        </div>

        <div class="section">
            <h2>排除教師名單:</h2>
            <textarea id="excludedTeachers" rows="4" cols="50"></textarea>
            <h3>排序方式：</h3>
            <select id="sortMethod">
                <option value="substCount">以代堂數排序（由小至大）</option>
                <option value="freePeriods">以空堂數目排序</option>
            </select>
            <button onclick="confirmArrangement()">確認本次安排</button>
        </div>

        <div class="section">
            <h2>代課結果:</h2>
            <table id="resultTable">
                <thead>
                    <tr>
                        <th>請假教師</th>
                        <th>代課教師</th>
                        <th>日期</th>
                        <th>堂數</th>
                    </tr>
                </thead>
                <tbody id="resultBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        let teachers = [];
        let substitutionRecords = [];
        let tempSubstitutions = [];

        // Load CSV file
        document.getElementById('substFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const text = e.target.result;
                    parseCSV(text);
                };
                reader.readAsText(file);
            }
        });

        function parseCSV(text) {
            const lines = text.split('\n').filter(line => line.trim());
            teachers = [];
            lines.forEach((line, index) => {
                if (index === 0) return; // Skip header
                const [name, substCount, freePeriods] = line.split(',').map(item => item.trim());
                teachers.push({
                    name,
                    substCount: parseInt(substCount) || 0,
                    freePeriods: parseInt(freePeriods) || 0
                });
            });
            populateTeacherDropdown();
        }

        function populateTeacherDropdown() {
            const select = document.getElementById('absentTeacher');
            select.innerHTML = '<option value="">-- 選擇教師 --</option>';
            teachers.forEach(teacher => {
                const option = document.createElement('option');
                option.value = teacher.name;
                option.textContent = teacher.name;
                select.appendChild(option);
            });
        }

        function arrangeSubstitution() {
            const absentTeacher = document.getElementById('absentTeacher').value;
            const subDate = document.getElementById('subDate').value;
            const maxPeriods = parseInt(document.getElementById('maxPeriods').value);
            const excludedTeachers = document.getElementById('excludedTeachers').value.split('\n').map(t => t.trim()).filter(t => t);
            const sortMethod = document.getElementById('sortMethod').value;
            const sixthFormFinished = document.getElementById('sixthFormFinished').checked;

            if (!absentTeacher || !subDate) {
                alert('請選擇請假教師和代課日期');
                return;
            }

            // Filter available teachers
            let availableTeachers = teachers.filter(teacher => 
                teacher.name !== absentTeacher &&
                !excludedTeachers.includes(teacher.name) &&
                teacher.substCount < maxPeriods
            );

            // Sort teachers based on selection criteria
            availableTeachers.sort((a, b) => {
                if (sortMethod === 'substCount') {
                    return a.substCount - b.substCount;
                } else {
                    return b.freePeriods - a.freePeriods;
                }
            });

            // Select substitute teacher (first available)
            const substituteTeacher = availableTeachers[0];
            if (!substituteTeacher) {
                alert('沒有可用的代課教師');
                return;
            }

            // Store temporary substitution
            tempSubstitutions.push({
                absentTeacher,
                substituteTeacher: substituteTeacher.name,
                date: subDate,
                periods: 1 // Assuming 1 period per substitution
            });

            displayResults();
        }

        function confirmArrangement() {
            const absentTeacher = document.getElementById('absentTeacher').value;
            if (!tempSubstitutions.length) {
                alert('請先編排代課');
                return;
            }

            // Update substitution counts
            tempSubstitutions.forEach(sub => {
                const absent = teachers.find(t => t.name === sub.absentTeacher);
                const substitute = teachers.find(t => t.name === sub.substituteTeacher);
                if (absent) absent.substCount -= sub.periods;
                if (substitute) substitute.substCount += 1;
            });

            // Move to permanent records
            substitutionRecords.push(...tempSubstitutions);
            tempSubstitutions = [];
            displayResults();
        }

        function displayResults() {
            const tbody = document.getElementById('resultBody');
            tbody.innerHTML = '';
            [...substitutionRecords, ...tempSubstitutions].forEach(sub => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${sub.absentTeacher}</td>
                    <td>${sub.substituteTeacher}</td>
                    <td>${sub.date}</td>
                    <td>${sub.periods}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function downloadSubst() {
            // Generate CSV content
            let csvContent = 'Teacher,SubstCount,FreePeriods\n';
            teachers.forEach(teacher => {
                csvContent += `${teacher.name},${teacher.substCount},${teacher.freePeriods}\n`;
            });

            // Create and download CSV
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'subst_updated.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
